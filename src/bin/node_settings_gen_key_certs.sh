#!/bin/sh

echo " "
echo "//-----------------------------//"
echo "Generate keys in src/bin/tls_data"
echo "//-----------------------------//"
echo " "

cd src/bin/tls_data

if [ "$1" = "re_gen_keys" ]
then
  for n in node compute1 compute2 compute3 storage1 storage2 storage3 miner1 miner2 miner3 miner4 miner5 miner6 miner7 miner8 miner9 miner10 user1 user2 
  do
    echo "Generating ... n is set to $n"
    openssl req -config node.cnf -new -newkey rsa:4096 -nodes -keyout $n.key -out $n.csr -subj "/CN=$n.zenotta.xyz" -addext "subjectAltName = DNS:$n.zenotta.xyz"
    openssl req -config node.cnf -new -x509 -in $n.csr -key $n.key -out $n.pem -addext "subjectAltName = DNS:$n.zenotta.xyz"
  done
fi

echo " "
echo "//-----------------------------//"
echo "Generate JSON in src/bin/tls_data: REQUIRE jq executable"
echo "//-----------------------------//"
echo " "

rm tls_certificates.json
rm test_tls_certificates.rs
echo "{" >> tls_certificates.json
echo "    \"file_comment\": [" >> tls_certificates.json
echo "        \"/// !!! AUTOGENERATED: DO NOT EDIT !!!\"," >> tls_certificates.json
echo "        \"/// Generated with: src/bin/node_settings_gen_key_certs.sh\"" >> tls_certificates.json
echo "    ]," >> tls_certificates.json
echo "    \"tls_config\": {" >> tls_certificates.json
echo "        \"pem_certificates\": {" >> tls_certificates.json

echo "/// !!! AUTOGENERATED: DO NOT EDIT !!!" >> test_tls_certificates.rs
echo "/// Generated with: \`src/bin/node_settings_gen_key_certs.sh\`" >> test_tls_certificates.rs
echo "" >> test_tls_certificates.rs
echo "/// PEM certificates for node DNS names" >> test_tls_certificates.rs
echo "pub const TEST_PEM_CERTIFICATES: &[(&str, &str)] = &[" >> test_tls_certificates.rs

for n in compute1 compute2 compute3 storage1 storage2 storage3 miner1 miner2 miner3 miner4 miner5 miner6 miner7 miner8 miner9 miner10 user1 user2 
do
  echo "Generating test json and rs cert ... n is set to $n"
  printf "            \"$n.zenotta.xyz\": %s,\n" "$(jq -Rs . <$n.pem)" >> tls_certificates.json
  printf "(\"$n.zenotta.xyz\", %s),\n" "$(jq -Rs . <$n.pem)" >> test_tls_certificates.rs
done

printf "            \"node.zenotta.xyz\": %s\n" "$(jq -Rs . <node.pem)" >> tls_certificates.json
echo "        }," >> tls_certificates.json
echo "        \"pem_rsa_private_keys\": {" >> tls_certificates.json

printf "(\"node.zenotta.xyz\", %s),\n" "$(jq -Rs . <node.pem)" >> test_tls_certificates.rs
echo "];" >> test_tls_certificates.rs
echo "" >> test_tls_certificates.rs
echo "/// RSA Keys for node DNS names" >> test_tls_certificates.rs
echo "pub const TEST_RSA_KEYS: &[(&str, &str)] = &[" >> test_tls_certificates.rs

for n in compute1 compute2 compute3 storage1 storage2 storage3 miner1 miner2 miner3 miner4 miner5 miner6 miner7 miner8 miner9 miner10 user1 user2 
do
  echo "Generating test json and rs keys ... n is set to $n"
  printf "            \"$n.zenotta.xyz\": %s,\n" "$(jq -Rs . <$n.key)" >> tls_certificates.json
  printf "(\"$n.zenotta.xyz\", %s),\n" "$(jq -Rs . <$n.key)" >> test_tls_certificates.rs
done

printf "            \"node.zenotta.xyz\": %s\n" "$(jq -Rs . <node.key)" >> tls_certificates.json
echo "        }," >> tls_certificates.json
echo "        \"socket_name_mapping\": {" >> tls_certificates.json
echo "            \"127.0.0.1:12300\": \"compute1.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12301\": \"compute2.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12302\": \"compute3.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12330\": \"storage1.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12331\": \"storage2.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12332\": \"storage3.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12340\": \"miner1.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12341\": \"miner2.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12342\": \"miner3.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12343\": \"miner4.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12344\": \"miner5.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12345\": \"miner6.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12346\": \"miner7.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12347\": \"miner8.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12348\": \"miner9.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12349\": \"miner10.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12360\": \"user1.zenotta.xyz\"," >> tls_certificates.json
echo "            \"127.0.0.1:12361\": \"user2.zenotta.xyz\"" >> tls_certificates.json
echo "        }" >> tls_certificates.json
echo "    }" >> tls_certificates.json
echo "}" >> tls_certificates.json

printf "(\"node.zenotta.xyz\", %s),\n" "$(jq -Rs . <node.key)" >> test_tls_certificates.rs
echo "];" >> test_tls_certificates.rs

mv tls_certificates.json ../tls_certificates.json
mv test_tls_certificates.rs ../../comms_handler/test_tls_certificates.rs
